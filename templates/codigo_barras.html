{% extends "base.html" %}

{% block title %}Leitor de C√≥digo de Barras - Sistema Espetinho{% endblock %}

{% block extra_css %}
<style>
#interactive.viewport {
    position: relative;
    width: 100%;
    height: 300px;
}
#interactive.viewport > canvas, #interactive.viewport > video {
    max-width: 100%;
    width: 100%;
}
canvas.drawing, canvas.drawingBuffer {
    position: absolute;
    left: 0;
    top: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Leitor de C√≥digo de Barras</h1>
            <p class="text-muted">Use a c√¢mera ou digite o c√≥digo para buscar produtos</p>
        </div>
        <div>
            <a href="{{ url_for('produtos') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>
        </div>
    </div>

    <!-- √Årea de Notifica√ß√µes -->
    <div id="notificacao" class="alert" style="display: none;" role="alert">
        <span id="notificacao-mensagem"></span>
        <button type="button" class="btn-close" onclick="fecharNotificacao()"></button>
    </div>

    <div class="row">
        <!-- Coluna da C√¢mera -->
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-camera me-2"></i>
                        C√¢mera
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div id="interactive" class="viewport"></div>
                    </div>
                    
                    <!-- Status da c√¢mera -->
                    <div class="mt-2 text-center">
                        <span id="cameraStatus" class="badge bg-secondary">
                            <i class="fas fa-circle me-1"></i>Status: Aguardando
                        </span>
                    </div>
                    
                    <!-- Informa√ß√µes de diagn√≥stico -->
                    <div class="mt-2 small text-muted">
                        <div><strong>Navegador:</strong> <span id="navegadorInfo">Detectando...</span></div>
                        <div><strong>Protocolo:</strong> <span id="protocoloInfo">Detectando...</span></div>
                        <div><strong>Suporte c√¢mera:</strong> <span id="suporteCamera">Detectando...</span></div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button id="startButton" class="btn btn-primary" onclick="startScanner()">
                            <i class="fas fa-play me-2"></i>Iniciar Scanner
                        </button>
                        <button id="stopButton" class="btn btn-danger" onclick="stopScanner()" style="display: none;">
                            <i class="fas fa-stop me-2"></i>Parar Scanner
                        </button>
                        <button id="testButton" class="btn btn-outline-info btn-sm" onclick="testarCamera()">
                            <i class="fas fa-camera me-1"></i>Testar C√¢mera
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Aponte a c√¢mera para o c√≥digo de barras. O scanner detectar√° automaticamente.
                        </small>
                    </div>
                    
                    <!-- Dicas de uso -->
                    <div class="mt-3">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-lightbulb me-1"></i>Dicas para melhor leitura:
                            </h6>
                            <ul class="mb-0 small">
                                <li>Mantenha a c√¢mera est√°vel e bem iluminada</li>
                                <li>Posicione o c√≥digo de barras no centro da tela</li>
                                <li>Evite reflexos e sombras no c√≥digo</li>
                                <li>Se n√£o funcionar, use a busca manual abaixo</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Solu√ß√£o de problemas -->
                    <div class="mt-3">
                        <details>
                            <summary class="text-muted small">
                                <i class="fas fa-tools me-1"></i>Problemas com a c√¢mera?
                            </summary>
                            <div class="mt-2 small">
                                <ul class="mb-0">
                                    <li><strong>Permiss√£o negada:</strong> Clique no √≠cone da c√¢mera na barra de endere√ßos e permita o acesso</li>
                                    <li><strong>C√¢mera n√£o funciona:</strong> Verifique se n√£o est√° sendo usada por outro app</li>
                                    <li><strong>N√£o detecta c√≥digos:</strong> Tente ajustar a dist√¢ncia e ilumina√ß√£o</li>
                                    <li><strong>Navegador antigo:</strong> Use Chrome, Firefox ou Edge atualizado</li>
                                </ul>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coluna de Busca Manual -->
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-keyboard me-2"></i>
                        Busca Manual
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="codigoManual" class="form-label">C√≥digo de Barras</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="codigoManual" 
                                   placeholder="Digite ou cole o c√≥digo de barras">
                            <button class="btn btn-primary" onclick="buscarCodigoManual()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Resultado da Busca -->
                    <div id="resultadoBusca" style="display: none;">
                        <hr>
                        <h6>Resultado da Busca:</h6>
                        <div id="produtoEncontrado" class="alert alert-success" style="display: none;">
                            <h6 class="alert-heading">Produto Encontrado!</h6>
                            <div id="infoProduto"></div>
                            <hr>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="editarProduto()">
                                    <i class="fas fa-edit me-1"></i>Editar
                                </button>
                                <button class="btn btn-sm btn-success" onclick="adicionarEstoque()">
                                    <i class="fas fa-plus me-1"></i>Adicionar Estoque
                                </button>
                            </div>
                        </div>
                        <div id="produtoNaoEncontrado" class="alert alert-warning" style="display: none;">
                            <h6 class="alert-heading">Produto N√£o Encontrado</h6>
                            <p class="mb-0">Este c√≥digo de barras n√£o est√° cadastrado no sistema.</p>
                            <hr>
                            <button class="btn btn-sm btn-success" onclick="cadastrarNovoProduto()">
                                <i class="fas fa-plus me-1"></i>Cadastrar Novo Produto
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QuaggaJS Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<script>
let scannerRunning = false;
let produtoAtual = null;

// Fun√ß√£o auxiliar para verificar se √© IP local
function isLocalIPAddress(hostname) {
    return hostname === 'localhost' || 
           hostname === '127.0.0.1' || 
           hostname === '10.0.0.105' ||
           hostname.startsWith('192.168.') ||
           hostname.startsWith('10.0.');
}

// Fun√ß√µes do scanner
function updateCameraStatus(status, color = 'secondary') {
    const statusElement = document.getElementById('cameraStatus');
    statusElement.className = `badge bg-${color}`;
    statusElement.innerHTML = `<i class="fas fa-circle me-1"></i>Status: ${status}`;
}

function startScanner() {
    if (scannerRunning) return;
    
    updateCameraStatus('Iniciando...', 'warning');
    
    // Debug: mostrar informa√ß√µes do ambiente
    console.log('üîç Debug - Protocolo:', location.protocol);
    console.log('üîç Debug - Hostname:', location.hostname);
    console.log('üîç Debug - URL completa:', location.href);
    console.log('üîç Debug - √â IP local?', isLocalIPAddress(location.hostname));
    
    // Verificar se o navegador suporta getUserMedia
    if (!navigator.mediaDevices) {
        mostrarNotificacao('Seu navegador n√£o suporta acesso √† c√¢mera (mediaDevices n√£o dispon√≠vel). Use a busca manual.', 'error');
        updateCameraStatus('N√£o suportado', 'danger');
        return;
    }
    
    if (!navigator.mediaDevices.getUserMedia) {
        mostrarNotificacao('Seu navegador n√£o suporta getUserMedia. Use a busca manual.', 'error');
        updateCameraStatus('N√£o suportado', 'danger');
        return;
    }
    
    // Verificar se est√° em HTTPS ou IP local (necess√°rio para c√¢mera)
    if (location.protocol !== 'https:' && !isLocalIPAddress(location.hostname)) {
        mostrarNotificacao('Acesso √† c√¢mera requer HTTPS ou IP local. Use a busca manual ou acesse via localhost/IP local.', 'error');
        updateCameraStatus('HTTPS necess√°rio', 'danger');
        return;
    }
    
    // Primeiro, solicitar permiss√£o da c√¢mera
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
            // Parar o stream imediatamente para liberar a c√¢mera
            stream.getTracks().forEach(track => track.stop());
            
            // Agora inicializar o Quagga
            initQuagga();
        })
        .catch(function(err) {
            console.error('Erro ao acessar c√¢mera:', err);
            updateCameraStatus('Erro', 'danger');
            
            if (err.name === 'NotAllowedError') {
                mostrarNotificacao('Permiss√£o da c√¢mera negada. Clique no √≠cone da c√¢mera na barra de endere√ßos e permita o acesso.', 'error');
            } else if (err.name === 'NotFoundError') {
                mostrarNotificacao('Nenhuma c√¢mera encontrada no dispositivo.', 'error');
            } else if (err.name === 'NotReadableError') {
                mostrarNotificacao('C√¢mera est√° sendo usada por outro aplicativo.', 'error');
            } else {
                mostrarNotificacao('Erro ao acessar c√¢mera: ' + err.message, 'error');
            }
        });
}

function initQuagga() {
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: "#interactive",
            constraints: {
                width: { min: 640, ideal: 1280, max: 1920 },
                height: { min: 480, ideal: 720, max: 1080 },
                facingMode: "environment", // Usar c√¢mera traseira no celular
                aspectRatio: { min: 1, max: 2 }
            },
        },
        locator: {
            patchSize: "medium",
            halfSample: true
        },
        numOfWorkers: navigator.hardwareConcurrency || 2,
        frequency: 10,
        decoder: {
            readers: [
                "code_128_reader",
                "ean_reader",
                "ean_8_reader",
                "code_39_reader",
                "code_39_vin_reader",
                "codabar_reader",
                "upc_reader",
                "upc_e_reader",
                "i2of5_reader"
            ]
        },
        locate: true
    }, function(err) {
        if (err) {
            console.error('Erro ao inicializar Quagga:', err);
            mostrarNotificacao('Erro ao inicializar scanner: ' + err.message, 'error');
            return;
        }
        
        console.log('Quagga inicializado com sucesso');
        Quagga.start();
        scannerRunning = true;
        
        document.getElementById('startButton').style.display = 'none';
        document.getElementById('stopButton').style.display = 'block';
        
        updateCameraStatus('Ativo', 'success');
        mostrarNotificacao('Scanner iniciado com sucesso! Aponte para um c√≥digo de barras.', 'success');
    });
    
    // Listener para c√≥digos detectados
    Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        console.log('C√≥digo detectado:', code);
        
        // Parar scanner ap√≥s detectar
        stopScanner();
        
        // Preencher campo e buscar
        document.getElementById('codigoManual').value = code;
        buscarCodigoManual();
        
        // Som de sucesso (opcional)
        mostrarNotificacao(`C√≥digo lido: ${code}`, 'success');
    });
    
    // Listener para erros do Quagga
    Quagga.onProcessed(function(result) {
        if (result) {
            if (result.codeResult && result.codeResult.code) {
                console.log('C√≥digo processado:', result.codeResult.code);
            }
        }
    });
    
    // Listener para erros
    Quagga.onError(function(err) {
        console.error('Erro do Quagga:', err);
        updateCameraStatus('Erro', 'danger');
        if (err.name === 'NotSupportedError') {
            mostrarNotificacao('Formato de c√≥digo de barras n√£o suportado.', 'error');
        }
    });
}

function stopScanner() {
    if (!scannerRunning) return;
    
    Quagga.stop();
    scannerRunning = false;
    
    document.getElementById('startButton').style.display = 'block';
    document.getElementById('stopButton').style.display = 'none';
    
    updateCameraStatus('Parado', 'secondary');
    mostrarNotificacao('Scanner parado', 'info');
}

function testarCamera() {
    // Debug: mostrar informa√ß√µes do ambiente
    console.log('üîç Debug Teste - Protocolo:', location.protocol);
    console.log('üîç Debug Teste - Hostname:', location.hostname);
    console.log('üîç Debug Teste - URL completa:', location.href);
    console.log('üîç Debug Teste - √â IP local?', isLocalIPAddress(location.hostname));
    
    // Verifica√ß√µes detalhadas
    if (!navigator.mediaDevices) {
        mostrarNotificacao('‚ùå mediaDevices n√£o dispon√≠vel no navegador.', 'error');
        updateCameraStatus('N√£o suportado', 'danger');
        return;
    }
    
    if (!navigator.mediaDevices.getUserMedia) {
        mostrarNotificacao('‚ùå getUserMedia n√£o dispon√≠vel no navegador.', 'error');
        updateCameraStatus('N√£o suportado', 'danger');
        return;
    }
    
    // Verificar HTTPS ou IP local
    if (location.protocol !== 'https:' && !isLocalIPAddress(location.hostname)) {
        mostrarNotificacao('‚ùå Acesso √† c√¢mera requer HTTPS ou IP local. Use localhost/IP local ou HTTPS.', 'error');
        updateCameraStatus('HTTPS necess√°rio', 'danger');
        return;
    }
    
    updateCameraStatus('Testando...', 'warning');
    mostrarNotificacao('üîç Testando c√¢mera...', 'info');
    
    navigator.mediaDevices.getUserMedia({ 
        video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
        } 
    })
    .then(function(stream) {
        updateCameraStatus('Funcionando', 'success');
        mostrarNotificacao('‚úÖ C√¢mera funcionando! Pode usar o scanner.', 'success');
        // Parar o stream de teste
        stream.getTracks().forEach(track => track.stop());
    })
    .catch(function(err) {
        console.error('Erro no teste da c√¢mera:', err);
        updateCameraStatus('Erro', 'danger');
        let mensagem = 'Erro ao testar c√¢mera: ';
        
        switch(err.name) {
            case 'NotAllowedError':
                mensagem = '‚ùå Permiss√£o da c√¢mera negada. Clique no √≠cone da c√¢mera na barra de endere√ßos.';
                break;
            case 'NotFoundError':
                mensagem = '‚ùå Nenhuma c√¢mera encontrada no dispositivo.';
                break;
            case 'NotReadableError':
                mensagem = '‚ùå C√¢mera est√° sendo usada por outro aplicativo.';
                break;
            case 'OverconstrainedError':
                mensagem = '‚ùå Configura√ß√£o da c√¢mera n√£o suportada.';
                break;
            case 'NotSupportedError':
                mensagem = '‚ùå Formato de v√≠deo n√£o suportado.';
                break;
            default:
                mensagem += err.message;
        }
        
        mostrarNotificacao(mensagem, 'error');
    });
}

// Fun√ß√µes de busca
async function buscarCodigoManual() {
    const codigo = document.getElementById('codigoManual').value.trim();
    
    if (!codigo) {
        mostrarNotificacao('Digite um c√≥digo de barras', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/buscar-produto-codigo/${codigo}`);
        const data = await response.json();
        
        document.getElementById('resultadoBusca').style.display = 'block';
        
        if (data.success && data.produto) {
            produtoAtual = data.produto;
            mostrarProdutoEncontrado(data.produto);
        } else {
            produtoAtual = null;
            mostrarProdutoNaoEncontrado();
        }
    } catch (error) {
        console.error('Erro na busca:', error);
        mostrarNotificacao('Erro ao buscar produto', 'error');
    }
}

function mostrarProdutoEncontrado(produto) {
    document.getElementById('produtoEncontrado').style.display = 'block';
    document.getElementById('produtoNaoEncontrado').style.display = 'none';
    
    const infoHtml = `
        <p><strong>Nome:</strong> ${produto.nome}</p>
        <p><strong>Tipo:</strong> ${produto.tipo}</p>
        <p><strong>Pre√ßo:</strong> R$ ${produto.preco_padrao.toFixed(2)}</p>
        ${produto.descricao ? `<p><strong>Descri√ß√£o:</strong> ${produto.descricao}</p>` : ''}
    `;
    
    document.getElementById('infoProduto').innerHTML = infoHtml;
}

function mostrarProdutoNaoEncontrado() {
    document.getElementById('produtoEncontrado').style.display = 'none';
    document.getElementById('produtoNaoEncontrado').style.display = 'block';
}

// Fun√ß√µes de a√ß√£o
function editarProduto() {
    if (produtoAtual) {
        window.location.href = `/produto/${produtoAtual.id}/editar`;
    }
}

function adicionarEstoque() {
    if (produtoAtual) {
        window.location.href = `/estoque/adicionar?produto_id=${produtoAtual.id}`;
    }
}

function cadastrarNovoProduto() {
    const codigo = document.getElementById('codigoManual').value.trim();
    if (codigo) {
        // Redirecionar para novo produto com o c√≥digo preenchido
        window.location.href = `/produto/novo?codigo_barras=${encodeURIComponent(codigo)}`;
    } else {
        window.location.href = '/produto/novo';
    }
}

// Fun√ß√µes de notifica√ß√£o
function mostrarNotificacao(mensagem, tipo) {
    const notificacao = document.getElementById('notificacao');
    const mensagemElement = document.getElementById('notificacao-mensagem');
    
    notificacao.className = 'alert';
    
    if (tipo === 'success') {
        notificacao.classList.add('alert-success');
    } else if (tipo === 'error') {
        notificacao.classList.add('alert-danger');
    } else {
        notificacao.classList.add('alert-info');
    }
    
    mensagemElement.textContent = mensagem;
    notificacao.style.display = 'block';
    
    setTimeout(() => {
        fecharNotificacao();
    }, 5000);
}

function fecharNotificacao() {
    document.getElementById('notificacao').style.display = 'none';
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Verificar compatibilidade da c√¢mera ao carregar
    verificarCompatibilidadeCamera();
    
    // Permitir busca com Enter
    document.getElementById('codigoManual').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarCodigoManual();
        }
    });
    
    // Parar scanner quando sair da p√°gina
    window.addEventListener('beforeunload', function() {
        if (scannerRunning) {
            stopScanner();
        }
    });
});

function verificarCompatibilidadeCamera() {
    // Detectar navegador
    const userAgent = navigator.userAgent;
    let navegador = 'Desconhecido';
    if (userAgent.includes('Chrome')) navegador = 'Chrome';
    else if (userAgent.includes('Firefox')) navegador = 'Firefox';
    else if (userAgent.includes('Safari')) navegador = 'Safari';
    else if (userAgent.includes('Edge')) navegador = 'Edge';
    
    document.getElementById('navegadorInfo').textContent = navegador;
    document.getElementById('protocoloInfo').textContent = location.protocol + '//' + location.hostname;
    
    // Verificar se √© IP local
    if (isLocalIPAddress(location.hostname)) {
        document.getElementById('protocoloInfo').textContent += ' (IP Local)';
    }
    
    // Verificar se o navegador suporta c√¢mera
    if (!navigator.mediaDevices) {
        updateCameraStatus('N√£o suportado', 'danger');
        document.getElementById('suporteCamera').textContent = '‚ùå mediaDevices n√£o dispon√≠vel';
        return;
    }
    
    if (!navigator.mediaDevices.getUserMedia) {
        updateCameraStatus('N√£o suportado', 'danger');
        document.getElementById('suporteCamera').textContent = '‚ùå getUserMedia n√£o dispon√≠vel';
        return;
    }
    
    // Verificar HTTPS ou IP local
    if (location.protocol !== 'https:' && !isLocalIPAddress(location.hostname)) {
        updateCameraStatus('HTTPS necess√°rio', 'warning');
        document.getElementById('suporteCamera').textContent = '‚ö†Ô∏è HTTPS ou IP local necess√°rio';
        return;
    }
    
    // Se chegou at√© aqui, o navegador suporta
    updateCameraStatus('Pronto', 'success');
    document.getElementById('suporteCamera').textContent = '‚úÖ Suportado';
}
</script>
{% endblock %} 